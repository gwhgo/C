#计算机体系结构基础
现代计算机都是基于Von Neumann体系结构的，不管是嵌入式系统、PC还是服务器。
这种体系结构的主要特点是: CPU (Central Processing Unit) + Memory

## 内存与地址

## CPU
CPU总是周而复始地做同一件事：从内存取指令，然后解释执行它，然后再取下一条指令，再解释执行。CPU最核心的功能单元包括：
- 寄存器(Register)是CPU内部的告诉存储器。
- 程序计数器(Program Counter, PC) 是一种特殊寄存器，保存着CPU取下一条指令的地址。取完指令后加上指令长度，作为PC的值。
- 指令译码器(Instruction Decoder) CPU取上来的指令由若干字节组成，这些字节中有些位保存内存地址，有些位表示寄存器编号，有些位表示这种指令做什么操作，加减乘除还是读写内存。指令译码器
负责解释这条指令的含义，然后调动相应的单元去执行它。
- 算术逻辑单元(Arithmetic and Logic Unit, ALU)。如果译码器将一条指令解释为运算指令，就调动算术逻辑端元去做运算，比如加减乘除、除运算、逻辑运算。指令中会指示结果存到哪里，可能保存到
寄存器中，也可能保存到内存中。
- 地址和数据总线(Bus) CPU和内存之间用地址总线、数据总线和控制线连接起来，每条线上有1和0两种状态 。
1. CPU内部将寄存器对接到数据总线上，使寄存器的每一位对接到一条数据线上。
2. CPU通过控制线发一个读请求，并且将内存地址通过地址线发送给内存。
3. 内存收到地址和读请求之后，将相应的内存单元接到数据总线的另一端，这样，内存单元每一位的0或者1通过一条数据线到达CPU寄存器中相应的位。就完成了数据的传送。

## 设备
有些设备像内存芯片一样连接到处理器的地址总线和数据总线，正因为地址线和数据线上可以挂多个设备和内存芯片，所以才叫总线，但不同的设备和内存芯片应该占用不同的地址范围。访问这种设备就像是
访问内存一样，按地址读写即可，但和访问内存不同的是，往一个地址写数据只是给设备发一个命令，数据不一定要保存，而从一个地址读数据也不一定是读先前保存在这个地址的数据，而是得到设备的当前
状态。设备中可供读写的单元通常称为设备寄存器（注意和CPU寄存器不是一回事），操作设备的过程就是读写这些设备寄存器的过程，比如像串口发送寄存器里写数据，串口设备就会把数据发送出去，读串口接收
寄存器的值，就可以读取串口设备接收到的数据。
还有一些设备集成在处理器芯片中。无论在CPU外部接总线的设备还是在CPU内部接总线的设备都有各自的地址范围，都可以像访问内存一样访问，很多体系结构 (比如ARM)采用这种方式操作设备，称为内存映射I/O
(Meomry-mapped I/O)。 但是x86比较特殊，对于设备有独立的端口地中间，访问设备需要用特殊的in/out指令，而不是和访问内存一样的指令，这种方式称为端口I/O(Port I/O)。

从CPU的角度来看，访问设备只有内存映射I/O和端口I/O两种，要么像内存一样访问，要么用一种专用的指令访问。 其实访问设备是非常复杂的，计算机的设备五花八门，各种设备的性能要求都不一样。
带宽大，响应快，热插拔。于是出现了使用不中要求的设备总线 -- PCI，AGP，USB，1394，SATA等，这些设备并不直接和CPU相连，CPU通过内存映射I/O或端口I/O访问相应的总线控制器，通过总线控制再去控制实际
的设备。 

内存是被动的。
设备往往会自己产生数据。 
中断机制： 每个设备都有一条中断线，通过中断控制器连接到CPU，当设备需要主动通知CPU时就引发一个中断信号，CPU正在执行的指令将被打断，程序计数器会指向某个固定的地址（有体系结构定义），于是CPU从这个
地址开始读取指令，执行中断服务程序(Interrupt Service Routing,ISR),完成中断处理后再返回先前被大段的地方执行后续指令。
ISR程序时内核代码的一部分，在这段代码中首先判断是哪个设备引发了中断，然后调用该设备的中断处理函数做进一步处理。

由于各种设备的操作方法不同，每个设备都需要专门的设备驱动程序(Device Driver),一个操作系统为了支持广泛的设备就需要有大量的设备驱动程序，事实上Linux内核源码中绝大部分是设备驱动程序。
设备驱动程序通常是内核里的一组函数，通过读写设备寄存器实现对设备的初始化、读、写等操作，有些设备还要提供一个中断处理函数供ISR调用。

## MMU
Virutal Memory Management
Momory Management Unit

CPU -VA-> MMU -PA-> Memory | 设备

MMU : 将VA映射成PA。

MMU 将VA映射到PA是页（Page)为单位的，32bit处理器的页尺寸通常是4KB。
MMU可以通过一个映射将VA的一页0xb7001000 ~ 0xb7001fff 映射到PA的一页0x2000~0x2ffff。
物理内存中的页称为物理页面或者页帧(Page Frame)。 
虚拟内存的页面映射到物理内存的页帧是通过页表(Page Table)来描述的，页表保存在物理内存中，MMU会查找页表来确定一个VA应该映射到什么PA。

操作系统和MMU:
- 操作系统在初始化或分配、释放内存时会执行一些在物理内中填写页表，然后用指令设置MMU，告诉MMU页表在物理内存中的什么位置。
- 设置好之后，CPU每次执行访问内存的指令都会自动引发MMU做查表和地址转换操作，地址转换操作由硬件自动完成，不需要指令控制MMU去做。

MMU的好处？
"All proglems  in computer science can be solved by another level of indirection.

内存保护机制  
各个体系结构都有用户模式(User Mode)和特权模式(Priviledged Mode)之分。
操作系统可以在页表中设置每个内存页面的访问权限，有些页面不允许访问，有些页面只有在CPU处于特权模式时允许访问，有些模式在两种模式都可以访问。
访问权限又分为可读、可写、可执行三种。设定好之后，当CPU要访问一个VA时，MMU会检查CPU当前处于用户模式还是特权模式,操作是什么。
不越权，才会转换成PA。
如果越权，就产生一个异常(Exception)， 异常的处理和中断，不同的是中断由外部设备产生而异常由CPU内部产生。
中断产生的原因和CPU当前执行的指令无关，而异常就是因为当前指令出现了问题。

## Memory Hierarchy

